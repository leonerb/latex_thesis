%<*Figure:multilabel-struc>
\begin{figure}[h]
	\centering
    \includegraphics[width=\textwidth]{figures/multilabel-struc.pdf}
    \caption{\textbf{Hierarchical structure of the CheXpert dataset.} 
	The labels are grouped into 14 categories.
	The dotted arrow from the Support Devices class indicates, that patients with a support device can also be labeled as No Finding, representing the only source of overlap between the No Finding class and other classes.
	Adapted from \citep{Irvin2019}.}
    \label{fig:multilabel-struc}
\end{figure}
%</Figure:multilabel-struc>

%<*Figure:pathologies>
\begin{figure}[h]
	\centering
	\begin{subfigure}[t]{0.3\textwidth}
		\includegraphics[width=\textwidth, height=\textwidth]{figures/attention-maps/cardiomegaly/img.png}
		\caption{Cardiomegaly}
		%\label{fig:first}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{0.3\textwidth}
		\includegraphics[width=\textwidth, height=\textwidth]{figures/pathologies/pneumonia_new_chex.jpg}
		\caption{Pneumonia}
		%\label{fig:second}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{0.3\textwidth}
		\includegraphics[width=\textwidth, height=\textwidth]{figures/pathologies/rib_frac_new_chex.jpg}
		\caption{Rib Fracture}
		%\label{fig:third}
	\end{subfigure}
	\hfill
	\vskip 1pt
	\begin{subfigure}[t]{0.3\textwidth}
		\includegraphics[width=\textwidth, height=\textwidth]{figures/attention-maps/pneumothorax/img.png}
		\caption{Pneumothorax}
		%\label{fig:fourth}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{0.3\textwidth}
		\includegraphics[width=\textwidth, height=\textwidth]{figures/attention-maps/lung_opacity/img.png}
		\caption{Lung Opacity}
		%\label{fig:fifth}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{0.3\textwidth}
		\includegraphics[width=\textwidth, height=\textwidth]{figures/attention-maps/pleural_effusion/img.png}
		\caption{Pleural Effusion}
		%\label{fig:sixth}
	\end{subfigure}	
	\caption{\textbf{Pathologies.} Pictures are taken from the CheXpert dataset \citep{Irvin2019}.}
	\label{fig:pathologies}
\end{figure}
%</Figure:pathologies>

%<*Figure:vit-arch>
\begin{figure}[ht]
	\centering
    \includegraphics[width=\textwidth]{figures/vit_arch_new.drawio.pdf}
	\caption{\textbf{Model architecture of the Vision Transformer.}
    The Chest X-ray image is taken from the CheXpert dataset \citep{Irvin2019} and the figure is adapted from \citep{Dosovitskiy2020}.}
	\label{fig:vit-arch}
\end{figure}
%</Figure:vit-arch>

%<*Figure:simclr-arch>
\begin{figure}[ht]
	\centering
    \includegraphics[width=\textwidth]{figures/simclr-arch-new.pdf}
	\caption{\textbf{SimCLR architecture.} 
	The Chest X-ray image is taken from the CheXpert dataset \citep{Irvin2019} and the figure is adapted from \citep{Chen2020}.
	}
	\label{fig:simclr-arch}
\end{figure}
%</Figure:simclr-arch>

%<*Figure:dino-arch>
\begin{figure}[ht]
	\centering
    \includegraphics[width=\textwidth]{figures/dino-arch-new.pdf}
	\caption{\textbf{DINO teacher and student network.} The figure is adapted from \citep{Caron2021}.
	A single pair of views $(x_1,x_2)$ is assumed for simplicity of illustration \citep{Caron2021}.
	Exponential moving average is abbreviated as EMA.
	The crossed out gradient $\cancel{\nabla}$ indicates, that there is a gradient back propagation for the student weights but not for the teacher weights.
	}
	\label{fig:dino-arch}
\end{figure}
%</Figure:dino-arch>

%<*Figure:setting1-chexnorm-v-imgnorm>
\begin{figure}[!htbp]
	\begin{subtable}[c]{\textwidth}
		%\renewcommand{\arraystretch}{1.2}
		\centering
		%\begin{tabular}{l c c c c} 
		\begin{tabular}{L{3cm} c c c c} 	
		\toprule
		& \multicolumn{2}{c}{SimCLR} & \multicolumn{2}{c}{DINO}\\
		\cmidrule(lr){2-3} \cmidrule(lr){4-5}
		OOD class& \multirow{2}{2.5cm}{\centering CheXpert norm.}& \multirow{2}{2.5cm}{\centering ImageNet norm.}& \multirow{2}{2.5cm}{\centering CheXpert norm.}& \multirow{2}{2.5cm}{\centering ImageNet norm.}\\
		%\midrule
		\\[-3pt]
		\midrule
		Cardiomegaly&57.81&55.26&58.24&\textbf{60.33}\\
		Fracture&53.43&54.53&\textbf{56.43}&55.69\\
		Lung Opacity&55.55&55.49&59.10&\textbf{60.30}\\
		Pleural Effusion&58.48&58.05&\textbf{64.33}&61.56\\
		Pneumothorax&60.10&60.54&57.51&\textbf{61.23}\\
		Support Devices&53.58&53.50&56.97&\textbf{57.44}\\
		\hline
		\multicolumn{1}{L{3cm}}{Mean $\Delta$ (ImageNet $-$ CheXpert)} & \multicolumn{2}{c}{$-$0.26 pp.} & \multicolumn{2}{c}{$+$0.66 pp.}  \\
		%\parbox[b]{2.8cm}{\noindent Avg. diff. (CheXpert - ImageNet)}& & & & \\
		%\multicolumn{1}{l}{\parbox[l]{3cm}{\centering Avg. diff. (CheXpert - ImageNet)}} & & & & \\
		%Avg. diff 
		%\multirow{3}{2cm}{\centering Avg. difference (CheX - ImageNet)} & & & & \\
		\bottomrule
		\end{tabular}
		\caption{AUROC (\%) values}
		\label{fig:setting1-chexnorm-v-imgnorm-dino-last-epoch}
	\end{subtable}
	\\
	\begin{subfigure}[t]{\textwidth}
		\centering
		\input{figures/setting1-imagenet-norm-dino-v-simclr-barplot.pgf}
		\caption{AUROC (\%) values for last epoch for ImageNet normalization}
		\label{fig:setting1-chexnorm-v-imgnorm-dino-barplot}
	\end{subfigure}
    \caption{\textbf{Comparison between CheXpert and ImageNet normalization for the first setting.}
	Table \ref{fig:setting1-chexnorm-v-imgnorm-dino-last-epoch} shows the results for SimCLR and DINO respectively across both normalizations.
	AUROC values are based on the feature similarity score and maximum values are marked in bold.
	Figure \ref{fig:setting1-chexnorm-v-imgnorm-dino-barplot} depicts the results for both models restricted to ImageNet normalization only.
	The dotted line refers to the performance equivalent to the chance level at 50\% AUROC.
	For the ImageNet normalization, all images were scaled with $\mu=(0.485, 0.456, 0.406)$ and $\sigma=(0.229, 0.224, 0.225)$. 
    The CheXpert normalization stands for a normalization with $\mu=(0.5330, 0.5330, 0.5330)$ and $\sigma=(0.0349, 0.0349, 0.0349)$ \citep[\href{https://github.com/christophbrgr/ood_detection_framework}{\color{Periwinkle}{implementation}}]{Berger2021}.
	The ID class is No Finding and OOD classes are the ones that are mentioned in the plot.}
	\label{fig:setting1-chexnorm-v-imgnorm}
\end{figure}
%</Figure:setting1-chexnorm-v-imgnorm>

%<*Figure:auroc-vs-k>
\begin{figure}[!htbp]
		\centering
		\input{figures/auroc-vs-k.pgf}
		%AUROC in relation to the number of nearest neighbours used for feature similarity.
	\caption{\textbf{AUROC (\%) values for setting 1 based on $k$-NN feature similarity with different values for $k$.}  
	The values are calculated as a top-3 average of the six OOD pathologies over Pleural Effusion, Cardiomegaly and Pneumothorax.
	$N_i$ refers to the length of the in-distribution train dataset of the i-th setting, where $i \in \{1,2,3\}$.}
	\label{fig:auroc-vs-k}
\end{figure}
%</Figure:auroc-vs-k>

% %<*Figure:auroc-vs-k-and-temp>
% \begin{figure}[!htbp]
% 	\begin{subfigure}[t]{\textwidth}
% 		\centering
% 		\input{figures/auroc-vs-k.pgf}
% 		\caption{}
% 		%AUROC in relation to the number of nearest neighbours used for feature similarity.
% 		\label{fig:auroc-vs-k}
% 	\end{subfigure}
% 	\begin{subfigure}[t]{\textwidth}
% 		\centering
% 		\input{figures/auroc-vs-temp.pgf}
% 		\caption{}
% 		%AUROC of settings 1-3 compared to the temperature.
% 		\label{fig:auroc-vs-temp}
% 	\end{subfigure}
% 	\caption{The values for setting 1 were calculated as a top-3 average of the six OOD pathologies over Pleural Effusion, Cardiomegaly and Pneumothorax.
% 	$N_i$ refers to the length of the in-distribution train dataset of the i-th setting, where $i \in \{1,2,3\}$.
% 	The temperature is set to 1 for all values in figure \ref{fig:auroc-vs-k}.}
% 	\label{fig:auroc-vs-k-and-temp}
% \end{figure}
% %</Figure:auroc-vs-k-and-temp>

%<*Figure:dino-rotate-augs-v-default-augs>
\begin{figure}[ht]
	\centering
	\input{figures/dino-rotate-augs-vs-default-augs-new.pgf}
	\caption{\textbf{Comparison between augmentations.} DINO augmentations ($\mathcal{T}_{DINO}$) and additionally a rotation between [-20, 20] degrees ($\mathcal{T}_{DINO+rot(20)}$, detailed in \ref{section: adapted-methods}) are applied.
	The AUROC is computed for the feature similarity score ($k=1$).}
	\label{fig:dino-rotate-augs-v-default-augs}
\end{figure}
%</Figure:dino-rotate-augs-v-default-augs>

%<*Figure:supervised-vs-unsupervised>
\begin{figure}[htbp]
	\centering
	\input{figures/supervised-vs-unsupervised.pgf}
	\caption{\textbf{Comparison of supervised (Sup ViT, Berger et al. \citep{Berger2021}) and unsupervised models (ViT DINO pretrained) for setting 2 and setting 3.}}
	\label{fig:supervised-vs-unsupervised}
\end{figure}
%</Figure:supervised-vs-unsupervised>

%<*Figure:labels-used-AUC-setting1>
\begin{figure}
	\centering
    \includegraphics[width=\textwidth]{figures/labels-used-AUC-setting1.pdf}
    \caption{}
    \label{fig:labels-used-AUC-setting1}
\end{figure}
%</Figure:labels-used-AUC-setting1>

%<*Figure:labels-used-AUC-setting2>
\begin{figure}
	\centering
    \includegraphics[width=\textwidth]{figures/labels-used-AUC-setting2.pdf}
	\caption{}
	\label{fig:labels-used-AUC-setting2}
\end{figure}
%</Figure:labels-used-AUC-setting2>

%<*Figure:heatmap-geom>
\begin{figure}
	\centering
	\begin{subfigure}[t]{0.45\textwidth}
		\includegraphics[width=\textwidth, height=0.8\textwidth]{figures/heatmap-geom-acc.pdf}
		\caption{k-nn accuracy}
		%\label{fig:third}
	\end{subfigure}
	\begin{subfigure}[t]{0.45\textwidth}
		\includegraphics[width=\textwidth, height=0.8\textwidth]{figures/heatmap-geom-auroc.pdf}
		\caption{AUROC OOD}
		%\label{fig:third}
	\end{subfigure}
    % \includegraphics[width=\textwidth]{figures/heatmap-geom-acc.pdf}
    \caption{k-nn classification accuracy and AUROC for different geometrical augmentations.}
    \label{fig:heatmap-geom}
\end{figure}
%</Figure:heatmap-geom>

%<*Figure:heatmap-spatial>
\begin{figure}
	\centering
	\begin{subfigure}[t]{0.45\textwidth}
		\includegraphics[width=\textwidth, height=0.8\textwidth]{figures/heatmap-spatial-acc.pdf}
		\caption{k-nn accuracy}
		%\label{fig:third}
	\end{subfigure}
	\begin{subfigure}[t]{0.45\textwidth}
		\includegraphics[width=\textwidth, height=0.8\textwidth]{figures/heatmap-spatial-auroc.pdf}
		\caption{AUROC OOD}
		%\label{fig:third}
	\end{subfigure}
    % \includegraphics[width=\textwidth]{figures/heatmap-spatial-acc.pdf}
    \caption{k-nn classification accuracy and AUROC for different spatial augmentations.}
    \label{fig:heatmap-spatial}
\end{figure}
%</Figure:heatmap-spatial>

%<*Figure:heatmap-ood-auc>
\begin{figure}
	\centering
    \includegraphics[width=\textwidth]{figures/heatmap-ood-auc.pdf}
    \caption{Averaged over both settings. 
	For a detailed breakdown of both settings see the appendix [\textcolor{red}{add REF}].}
    \label{fig:heatmap-ood-auc}
\end{figure}
%</Figure:heatmap-ood-auc>

%<*Figure:custom-augs-bbox>
\begin{figure}[!htbp]
	\centering
	\includegraphics[width=\textwidth]{figures/custom_augs_bbox.pdf}
	\caption{Bounding boxes of the custom augmentations.
	The green bounding boxes represent border values, where possible slices are sampled on which the augmentations are applied. 
	The red bounding boxes represent those slices.}
	\label{fig:custom-augs-bbox}
\end{figure}
%</Figure:custom-augs-bbox>

%<*Figure:custom-augs-applied>
\begin{figure}[!htbp]
	\centering
	\includegraphics[width=\textwidth]{figures/custom_augs_applied.pdf}
	\caption{\textbf{Custom augmentations applied to a frontal chest X-ray image.}
	The green bounding boxes represent border values, where possible slices are sampled on which the augmentations are applied. 
	The red bounding boxes represent those slices.
	The simulated rib fracture is in the upper part of the right image side (left side of the patient) and is marked with a blue arrow.}
	\label{fig:custom-augs-applied}
\end{figure}
%</Figure:custom-augs-applied>

%<*Figure:ood-fraction-avg>
\begin{figure}[h]
	\centering
	\input{figures/ood-fraction-avg.pgf}
	\caption{\textbf{Outlier exposure on Setting 1.} Average OOD detection performance between No Finding (ID) and Pleural Effusion, Cardiomegaly, Pneumothorax (OOD).
	Supervised outlier exposure assumes access to fine-grained OOD labels and unsupervised outlier exposure does not (see \ref{section: Out-of-Distribution Detection}).}
	\label{fig:ood-fraction-avg}
\end{figure}
%</Figure:ood-fraction-avg>

%<*Figure:ood-fraction-fracture>
\begin{figure}[!htbp]
	\centering
	\input{figures/ood-fraction-fracture.pgf}
	\caption{\textbf{Outlier exposure on setting 1.} OOD detection performance between No Finding (ID) and Fracture (OOD).
	Supervised outlier exposure assumes access to fine-grained OOD labels and unsupervised outlier exposure does not (see \ref{section: Out-of-Distribution Detection}).}
	\label{fig:ood-fraction-fracture}
\end{figure}
%</Figure:ood-fraction-fracture>





